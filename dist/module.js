/* [create-plugin] version: 6.7.6 */
/* [create-plugin] plugin: brade-dashboardtransporter-app@1.0.0 */
define(["@grafana/ui","@grafana/runtime","@grafana/data","react"],(e,t,n,r)=>(()=>{"use strict";var l={7(t){t.exports=e},531(e){e.exports=t},781(e){e.exports=n},959(e){e.exports=r}},o={};function a(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return l[e](n,n.exports,a),n.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};a.r(i),a.d(i,{plugin:()=>A});var s=a(781),u=a(959),d=a.n(u),c=a(7);const m="/health",v="/environments",p="/dashboards",y="/folders",f="/dashboards/import/batch";var h=a(531);function g(e,t,n,r,l,o,a){try{var i=e[o](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,l)}function E(e){return function(){var t=this,n=arguments;return new Promise(function(r,l){var o=e.apply(t,n);function a(e){g(o,r,l,a,i,"next",e)}function i(e){g(o,r,l,a,i,"throw",e)}a(void 0)})}}let S=null;function b(){return E(function*(){if(S)return S;const e=function(){const e=window;return[((null==e?void 0:e.__DASHBOARD_TRANSPORTER_BACKEND__)||"").toString().trim(),"/dashboard-transporter","http://localhost:8080"].filter(Boolean).map(e=>e.replace(/\/+$/,""))}();for(const t of e)try{const e=`${t}${m}`;if((yield fetch(e,{method:"GET"})).ok)return S=t,t}catch(e){}throw new Error(`Backend não encontrado. Testei: ${e.join(", ")}`)})()}function w(e){try{const t=JSON.parse(e);return(null==t?void 0:t.message)?String(t.message):JSON.stringify(t)}catch(t){return e}}function $(e){return E(function*(){const t=`${yield b()}${e.startsWith("/")?e:`/${e}`}`,n=yield fetch(t,{method:"GET"}),r=yield n.text();if(!n.ok){const e=w(r);throw new Error(`GET ${t} -> ${n.status}: ${e}`)}return JSON.parse(r)})()}function x(e,t,n,r,l,o,a){try{var i=e[o](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,l)}function B(e){return function(){var t=this,n=arguments;return new Promise(function(r,l){var o=e.apply(t,n);function a(e){x(o,r,l,a,i,"next",e)}function i(e){x(o,r,l,a,i,"throw",e)}a(void 0)})}}function O(e,t){const n=(e||"").trim(),r=n.length?n:(t||"").trim();if(!r)return{csv:"",users:[]};const l=r.split(/[,\n;\t]+/g).map(e=>e.trim()).filter(Boolean),o=new Set,a=[];for(const e of l){const t=e.toLowerCase();o.has(t)||(o.add(t),a.push(e))}return{csv:a.join(", "),users:a}}const A=(new s.AppPlugin).setRootPage(()=>{const[e,t]=(0,u.useState)(!1),[n,r]=(0,u.useState)([]),[l,o]=(0,u.useState)(null),[a,i]=(0,u.useState)(null),[s,m]=(0,u.useState)([]),[g,S]=(0,u.useState)(null),[x,A]=(0,u.useState)([]),[I,C]=(0,u.useState)(new Set),[P,T]=(0,u.useState)(""),[R,k]=(0,u.useState)(""),[N,j]=(0,u.useState)(null),[z,_]=(0,u.useState)(!0),[F,D]=(0,u.useState)(null),[J,U]=(0,u.useState)(null),W=(0,u.useMemo)(()=>n.map(e=>({label:`${e.name} (${e.id})`,value:e.id,env:e})),[n]),M=(0,u.useMemo)(()=>s.map(e=>({label:e.title||"General",value:e.uid,folder:e})),[s]);(0,u.useEffect)(()=>{B(function*(){t(!0),j(null),D(null),U(null);try{const e=yield E(function*(){try{const e=yield(0,h.getBackendSrv)().get("/api/user");return((null==e?void 0:e.login)||(null==e?void 0:e.email)||"").toString()}catch(e){return""}})();T(e);const t=yield B(function*(){return $(v)})();r(t);const n=t.find(e=>"dev"===e.id)||t[0]||null,l=t.find(e=>"hml"===e.id)||(t.length>1?t[1]:null);o(n),i(l)}catch(e){j({type:"error",text:(null==e?void 0:e.message)||"Erro ao carregar dados iniciais"})}finally{t(!1)}})()},[]),(0,u.useEffect)(()=>{(null==l?void 0:l.id)&&B(function*(){t(!0),j(null),A([]),C(new Set);try{const t=yield(e=l.id,B(function*(){return $(`${p}?env=${encodeURIComponent(e)}`)})());A(t)}catch(e){j({type:"error",text:(null==e?void 0:e.message)||`Erro ao carregar dashboards do ambiente ${l.id}`})}finally{t(!1)}var e})()},[null==l?void 0:l.id]),(0,u.useEffect)(()=>{(null==a?void 0:a.id)&&B(function*(){t(!0),j(null),m([]),S(null);try{const t=yield(e=a.id,B(function*(){return $(`${y}?env=${encodeURIComponent(e)}`)})());m(t),S(t[0]||{uid:"",title:"General"})}catch(e){j({type:"error",text:(null==e?void 0:e.message)||`Erro ao carregar pastas do ambiente ${a.id}`})}finally{t(!1)}var e})()},[null==a?void 0:a.id]);const G=(0,u.useMemo)(()=>O(R,P).users,[R,P]);return d().createElement("div",{style:{padding:16,maxWidth:1100}},N&&d().createElement(c.Alert,{severity:N.type,title:"success"===N.type?"Sucesso":"Erro"},d().createElement("pre",{style:{margin:0,whiteSpace:"pre-wrap"}},N.text)),d().createElement("h2",null,"Dashboards Transporter"),d().createElement(c.InlineFieldRow,{style:{marginBottom:16}},d().createElement(c.InlineField,{label:"Ambiente de Origem",labelWidth:22},d().createElement(c.Select,{width:28,options:W,value:l?{label:`${l.name} (${l.id})`,value:l.id}:void 0,onChange:e=>{var t;return o(null!==(t=null==e?void 0:e.env)&&void 0!==t?t:null)}})),d().createElement(c.InlineField,{label:"Ambiente de Destino",labelWidth:22},d().createElement(c.Select,{width:28,options:W,value:a?{label:`${a.name} (${a.id})`,value:a.id}:void 0,onChange:e=>{var t;return i(null!==(t=null==e?void 0:e.env)&&void 0!==t?t:null)}})),d().createElement(c.InlineField,{label:"Pasta no Destino",labelWidth:22},d().createElement(c.Select,{width:28,options:M,value:g?{label:g.title||"General",value:g.uid}:void 0,onChange:e=>{var t;return S(null!==(t=null==e?void 0:e.folder)&&void 0!==t?t:null)}}))),d().createElement(c.InlineFieldRow,{style:{marginBottom:12}},d().createElement(c.InlineField,{label:"Usuário logado",labelWidth:22},d().createElement(c.Input,{value:P||"Não identificado",readOnly:!0,width:60}))),d().createElement(c.InlineFieldRow,{style:{marginBottom:8}},d().createElement(c.InlineField,{label:"requestedBy (múltiplos)",labelWidth:22},d().createElement(c.Input,{value:R,onChange:e=>k(e.currentTarget.value),placeholder:"Ex: user1@..., user2@... (se vazio = usa usuário logado)",width:60}))),d().createElement("div",{style:{marginBottom:24,fontSize:12,opacity:.9}},d().createElement("div",null,d().createElement("b",null,"Preview RBAC:")," ",G.length?G.join(", "):"(nenhum)"),d().createElement("div",{style:{opacity:.75}},"Separadores aceitos: vírgula, ponto-e-vírgula, quebra de linha.")),d().createElement("h3",null,"Dashboards (",x.length,")"),d().createElement("div",{style:{marginBottom:12}},d().createElement(c.Button,{size:"sm",variant:"secondary",onClick:function(){C(new Set(x.map(e=>e.uid)))},disabled:!x.length},"Selecionar todos"),d().createElement(c.Button,{size:"sm",variant:"primary",onClick:function(){return B(function*(){if(j(null),D(null),U(null),!l||!a)return void j({type:"error",text:"Selecione ambiente de origem e destino."});if(!g)return void j({type:"error",text:"Selecione a pasta de destino."});const e=Array.from(I);if(!e.length)return void j({type:"error",text:"Selecione pelo menos 1 dashboard."});const n=O(R,P);if(n.users.length){t(!0);try{var r;const t={sourceEnv:l.id,targetEnv:a.id,folderUid:null!==(r=g.uid)&&void 0!==r?r:"",uids:e,requestedBy:n.csv};D(t);const s=yield(o=f,i=t,E(function*(){const e=`${yield b()}${o.startsWith("/")?o:`/${o}`}`,t=yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),n=yield t.text();if(!t.ok){const r=w(n);throw new Error(`POST ${e} -> ${t.status}: ${r}`)}return n?JSON.parse(n):{}})());U(s);const u=Array.isArray(s)?s.map(e=>{const t=e.message?` - ${e.message}`:"";return`${e.sourceUid} -> ${e.targetUid||e.sourceUid}: ${e.status}${t}`}).join("\n"):JSON.stringify(s),d=Array.isArray(s)&&s.some(e=>"error"===e.status),c=Array.isArray(s)&&s.some(e=>"warning"===e.status);j({type:d?"error":"success",text:(c?"Importação concluída com avisos.\n":"Importação concluída.\n")+`RBAC para: ${n.users.join(", ")}\n\n`+u})}catch(e){j({type:"error",text:(null==e?void 0:e.message)||"Falha no import"})}finally{t(!1)}var o,i}else j({type:"error",text:"requestedBy vazio e não foi possível detectar usuário logado."})})()},style:{marginLeft:8},disabled:!I.size||e},"Importar selecionados (",I.size,")"),d().createElement(c.Button,{size:"sm",variant:"secondary",onClick:()=>_(e=>!e),style:{marginLeft:8}},z?"Ocultar debug":"Mostrar debug")),e&&d().createElement(c.Spinner,null),z&&d().createElement("div",{style:{marginBottom:16}},d().createElement("div",{style:{fontSize:12,opacity:.9,marginBottom:6}},d().createElement("b",null,"Último payload enviado:")),d().createElement("pre",{style:{margin:0,padding:12,border:"1px solid #333",borderRadius:6,overflowX:"auto"}},F?JSON.stringify(F,null,2):"(nenhum ainda)"),d().createElement("div",{style:{fontSize:12,opacity:.9,marginTop:12,marginBottom:6}},d().createElement("b",null,"Última resposta do backend:")),d().createElement("pre",{style:{margin:0,padding:12,border:"1px solid #333",borderRadius:6,overflowX:"auto"}},J?JSON.stringify(J,null,2):"(nenhuma ainda)")),d().createElement("table",{style:{width:"100%"}},d().createElement("thead",null,d().createElement("tr",null,d().createElement("th",null),d().createElement("th",{style:{textAlign:"left"}},"Título"),d().createElement("th",{style:{textAlign:"left"}},"UID"))),d().createElement("tbody",null,x.map(e=>d().createElement("tr",{key:e.uid},d().createElement("td",null,d().createElement("input",{type:"checkbox",checked:I.has(e.uid),onChange:()=>{return t=e.uid,void C(e=>{const n=new Set(e);return n.has(t)?n.delete(t):n.add(t),n});var t}})),d().createElement("td",null,e.title),d().createElement("td",null,e.uid))))))});return i})());
//# sourceMappingURL=module.js.map